# 패션 이커머스 서비스의 아키텍처 성장 기록

 - 시작은 모놀리식
 - 마이크로서비스로의 전환
 - 성장 과정에서의 도전
 - 앞으로의 아키텍처 로드맵

## 1. 시작은 모놀리식

모놀리식 아키텍처는 비즈니스의 모든 도메인과 로직이 하나의 애플리케이션에 담기는 구조이다.
 - 단순함이 주는 명확한 장점
 - 쉬운 개발과 배포
 - 간소화된 테스트
 - 간편한 모니터링과 디버깅

다만, 서비스가 잘 성장하고 있다면 모놀리식 구조는 언젠가 한계 상황이 찾아오게 된다.  
2020년 시점의 29CM는 Python(Django) 기반의 하나의 애플리케이션에서 60 여개의 도메인(주문, 장바구니, 배송, 정산, 결제, 마일리지, 멤버쉽, 회원, 쿠폰, 브랜드, 등)이 실행되고 있었다.  
 - 시스템 장애 빈도가 점점 늘어난다.
 - 대량의 트래픽 인입시 장애로 이어진다.
 - 코드 배포 주기가 느리다.
 - 요구 사항 추가 및 변경이 어렵다.

## 2. 마이크로서비스로의 전환

2020년 08월 29CM는 마이크로서비스로의 전환을 결정한다.  
 - 확장성을 제공하는 아키텍처
 - 점진적인 코드 구조 개선이 가능

마이크로서비스는 무조건 좋은 것은 아니다. 모든 아키텍처 의사결정은 트레이드오프가 존재한다.

### 마이크로서비스 장점과 단점

- 장점
    - 증가하는 트래픽 처리가 쉽다.
    - 새로운 기능 추가를 빠르게 할 수 있다.
    - 조직 성장에 맞는 아키텍처 적용이 수월하다.
- 단점
    - 구현의 복잡도가 증가한다.
    - 테스트와 디버깅 비용이 커진다.
    - 서비스 간의 API 호출 Latency가 증가한다.

### 2020년 상황

 - 명확한 성장세: 전년 대비 성장, 누적 회원수 증가
 - 신규 기능 추가의 어려움: 60여개의 도메인을 구성하는 거대한 코드 볼륨
 - 오래된 레거시 아키텍처: 단순한 버그 업그레이드조차 부담스러운 상황

### 무엇을 어떻게 해야할까?

 - 목표: 마이크로서비스 전환
 - 계획
   - 전략: 마이크로서비스 전환을 위한 원칙, 아키텍처 가이드, 표준 구현 가이드
   - 공감대 형성: 동료들과 경영진의 공감대 형성
   - 채용: 동료 개발자 채용
   - 업무 방식 전환: 도메인 단위의 목적 조직으로 전환 (콘웨이 법칙)

#### 전략: 전환 원칙

 - 스트랭글러 패턴
   - 기존 기능과 동일한 로직을 신규 서비스에 구현한다.
   - LB 등을 활용하여 기존 서비스와 신규 서비스에 트래픽을 적절히 분배한다.
   - 신규 서비스의 검증이 완료되면 모든 트래픽을 신규 서비스에 전달하고, 기존 서비스 로직은 제거한다.
 - 새 기능은 신규 서비스로 구현
   - 새로운 기능 요건이 생길 때마다 신규 마이크로서비스에 구현
   - 앞으로 없앨 모놀리식 서비스에 신규 기능을 추가할 이유는 없다.
 - 임팩트 기준으로 모놀리식 분해 순서 결정
   - 도메인의 의존 관계를 생각하면 가장 하단의 도메인을 먼저 전환하는 것이 좋다.
   - 그러나, 비즈니스 임팩트가 큰 것을 먼저 전환할 때 얻게 되는 이익을 생각하자
 - 기존 서비스는 인증과 트래픽을 분배하는 역할로 활용
 - 표준 구현 가이드
   - 비즈니스의 가치를 명확히 충족하고 잘 읽혀야 하고 변경에 유연해야 하며 테스트 코드 작성이 쉬워야 함
   - 특정 기술에 종속되지 않으면서 요구사항을 잘 표현하는 도메인
   - 도메인의 실행을 위해 필요한 세부 기술
   - 둘 간의 연결을 추상화된 인터페이스와 이에 대한 의존성 주입
   
#### 동료 개발자 채용

 - 채용 문제를 해결하기 위해
   - Python(Django) -> Java(Spring)으로 전환
   - 한국에서는 Java(Spring) 개발자가 많고, 마이크로서비스로 Java(Spring)이 많다.

#### 이런 과정을 거쳐

 - 20 여개의 주요 도메인마다 독립된 서비스
 - k8s과 istio의 조합
 - 수백개의 컨테이너를 관리하고 운영

#### 마이크로서비스 전환 주요 팁

 - 모놀리스는 무조건 나쁜 것이 아니다. 상황에 따른 선택이다.
   - 서비스를 시작할 때 단순함이 주는 장점은 크다.
   - 그러나, 서비스가 지속적으로 커지면서 규모의 확장이 일어나면서 모놀리틱 서비스의 한계가 도래했을 때 마이크로서비스 전환을 고려하면 된다.
 - 다양한 기술 스택 선택이 가능하지만, 무조건 좋은 것은 아니다.
   - 마이크로서비스는 서비스와 서비스간에 통신으로 이루어져 서비스 내부에 대한 구현이 자유롭다.
   - 하지만, 전체적인 엔지니어링 팀이 필요로하는 기술적인 역량과 경험이 다르게 되며 특정 담당 팀원이 이탈하였을 때 백업할 수 있는 환경을 만들기 쉽지 안핟.
   - 즉, 어느정도 기술 스택의 제한을 걸고 진행하는 것이 좋을 수 있다.
 - 처음 도메인을 쪼갤 때에는 크게 쪼개고 세분화하는 것을 권장한다.
   - 자칫해서 너무 세분화해서 쪼개는 경우 다시 합쳐야하는 경우도 있고, 많이 쪼갤수록 개발비용과 운영비용가 증가할 수 있다.
   - 29CM에서도 처음부터 주문, 결제, 프로모션을 쪼개서 해도 되지만, 커머스라는 도메인으로 한 번에 쪼개고 이후에 잘게 나누었다.

## 3. 성장 과정에서의 도전

 - 장애 발생
   - 거래액의 증가, 트래픽의 증가, 다양한 기능의 추가와 코드 변경

### 2023년 02월 검색과 추천 서비스 장애

 - 장애의 원인: 순간적으로 20% 이상 높게 인입된 트래픽
   - 깊게 들여다보면, ElasticSearch에 전달된 트래픽 수준은 높았음 (40~50% 이상)
```
검색 트래픽 > 검색 서비스(search-service) -> 검색 엔진(Elastic Search)
추천 트래픽 > 추천 서비스(recommend-service) -> 추천 엔진에서 상품 아이디 획득 -> 검색 엔진(Elastic Search) 
```

 - 장애 회고
   - 장기 관점에서의 해결책
     - 검색 트래픽 처리 서비스와 상품 정보 조회 서비스의 분리 필요
     - Materialized View 구축
       - 클라이언트에서 다양한 도메인 정보를 필요로 할 때 모놀리틱에서는 하나의 API로 전달이 가능하다. 마이크로서비스에서는 도메인별 API를 호출하고 응답값을 조회해야 한다.
       - 개발 편의성과 성능 측면에서 Materialized View가 필요하다.
   - 단기 관점에서의 해결책
     - 추천 서비스가 필요로 하는 최소한의 ES 필드만 조회
       - 불필요한 필드 호출을 제거하여 CPU와 Memory 사용 최적화 (OOME 제거)
     - 추천 서비스 장애를 대비한 Fallback 응답 구현
       - 일정 주기마다 추천 응답을 Local Cache에 저장하고
       - 추천 로직에서 장애 발생 시 미리 저장한 추천 응답 활용 (fallback on)
     - ES 클러스터의 노드 증설(Scale Out)
       - ES 전체의 성능 확장을 위해 노드 증설
       - 가장 쉽고 빠른 대응. 비용을 지불사고 시간을 사는 것
       - 그러나, 모든 문제의 풀이를 Scale Out으로 할 수는 없음

### 스쿼드 중심 개발 과정에서의 고민

29CM는 스쿼드라는 목적 조직 단위로 제품을 개발하고 운영한다.  
스쿼드가 집중하는 도메인의 개발과 운영은 스쿼드의 개발자들이 주도적으로 수행한다.  
 - 서비스 일관성 VS 구현 속도
   - 스쿼드 내의 개발과 운영을 주도하는 개발자들은 스스로의 의사 결정과 구현에 대한 고민을 갖게된다. (잘하고 있는가?)
   - 소수의 시니어 개발자들이 모든 서비스의 설계와 개발을 도맡아 하는 것은 불가능하다.
   - 서비스의 일관성을 유지하면서 빠른 개발 속도를 유지할 수 있는 방안을 찾아야 한다.
 - 일관된 서비스에 대한 첨언
   - 일관된 컨셉이 위대한 설계의 가장 중요한 속성이다. 그것이 한 명 또는 일심동체로 일하는 소수의 사람들에게서 나오기 떄문에 ㅎ현명한 관리자는 과감하게 각각의 설계 작업을 재능 있는 수석 설계자에게 위임한다.
 - 개발 디자인 문서를 작성한다.
   - 시스템의 일관성을 최대한 유지하면서 빠른 구현 속도를 가져가고 구성원의 역량을 향상시킬 수 있는 방안
   - 문제 정의와 목표, 해결 방안, 제약 조건, 대안, 배포 방법, 운영 및 모니터링 방법 등
```
★ 개발 디자인 작성 문화
1. 담당 개발자의 스스로 해당 문서 작성
2. 이를 팀 내의 주요한 개발자들에게 리뷰 요청
3. 문서 리뷰 과정에서 담당 개발자가 생각했던 방향이 유효한지, 보완할 점은 없는지, 또 다른 좋은 대안은 없는지, 전체 시스템의 방향과 맞는지 논의
4. 이를 통해 담당 개발자는 전체 시스템 방향성에 맞는 설계와 개발 방향을 잡아감
5. 한정된 개발 리더 또는 시니어 개발자의 리소스도 충분히 활용
6. 담당 개발자는 문서 작성 과정에서 개인의 설계 역량, 글 쓰는 역량을 키움
```

## 4. 앞으로의 아키텍처 로드맵

 - Impact
   - 비즈니스 가치가 큰 서비스를 빠르게 출시할 수 있는 서비스 구조
   - Event Driven Architecture
 - Reliability
   - 대량의 트래픽을 안정적으로 처리하면서도 시스템의 장애나 버그가 발생하지 않는 서비스 구조
   - 서비스별 데이터베이스 분리
 - Productivity
   - 엔지니어링 구성원의 확장이 팀 전체의 생산성으로 이어지는 업무 환경
   - 팀 API 문화 적용

