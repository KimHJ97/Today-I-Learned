# 하루 1억 건 이상을 처리하는 견고한 포인트 시스템 구축하기

 - 견고함
    - 성능
    - 데이터 정합성
 - 포인트 시스템의 요구사항
    - 적립, 차감, 잔액 확인, 내역 확인
    - 다양한 포인트 타입
        - 광고 클릭 포인트, 미션 완료 포인트, 추천인 포인트, 수동 적립 포인트, 차감 포인트
        - 초기 설계: 각 포인트별로 테이블을 만들어 관리
            - 새로운 포인트 타입 추가 불편
            - 적립 내역 조회 성능 저하
        - 스키마 개선: 하나의 테이블로 관리
            - 자주 쓰이는 공통 필드를 정의
            - 나머지는 extra 컬럼에 json으로 저장
            - 적립 내역 조회 성능 향상
            - 새로운 포인트 타입 추가 용이
            - 잃은 것
                - 타입 안정성
                - 포인트 타입에 따른 테이블 최적화
 - 포인트 조회 시점과 업데이트 시점에 따른 잔액 에러
    - 네트워크 지연, 버튼 연타, 재시도 계층, 어뷰저
    - 잠금을 이용한 해결 방안(비관적 잠금)
        - 잠금 획득
        - 잔액 확인
        - 잠금 대기
        - 잔액 업데이트
        - 잠금 반환
    - 하나의 테이블로 통장 내역 처럼 관리
        - 찾은 금액, 남은 금액
        - 잔액은 마지막 레코드의 balance가 현재 잔액
    - 낙관적 잠금
        - 회원 ID와 Version을 Unique로 사용
        - 동일한 Version이 등록되면 예외 발생
            - Unique 에러 발생시 1번 재시도 처리
    - 동시성 문제가 발생하는 대표적인 사례
        - 좌석 예약 시스템
        - 재고 관리 시스템
        - 같은 폼을 동시에 수정하는 경우


## 정리

 - 단일 테이블 설계로 트랜잭션 제거
 - 2회 -> 1회로  쓰기 횟수 최적화
 - 낙관적 잠금을 통해 잠금 획득/반환 비용 제거
 - 관리형 NoSQL 서비스 사용을 통해 분산 처리 구현 위임
